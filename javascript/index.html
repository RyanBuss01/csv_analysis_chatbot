<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BankersGPS Analytics Chatbot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: hidden;
        }

        .chat-container {
            width: 90%;
            max-width: 900px;
            height: 95vh;
            max-height: 95vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            position: relative;
        }

        .analysis-selector {
            position: absolute;
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .analysis-dropdown {
            background: rgba(255, 255, 255, 0.95);
            color: #667eea;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            outline: none;
            transition: all 0.3s ease;
            min-width: 200px;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 5"><path fill="%23667eea" d="M2 0L0 2h4zm0 5L0 3h4z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 12px;
            padding-right: 35px;
        }

        .docs-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 10px;
            border-radius: 12px;
            color: #fff;
            font-size: 12px;
            user-select: none;
        }

        .docs-toggle input[type="checkbox"] {
            accent-color: #667eea;
            width: 16px;
            height: 16px;
        }

        .refresh-button {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 12px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .model-selector {
            position: absolute;
            top: 50%;
            right: 70px;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .model-dropdown {
            background: rgba(255, 255, 255, 0.95);
            color: #667eea;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            outline: none;
            transition: all 0.3s ease;
            min-width: 160px;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 5"><path fill="%23667eea" d="M2 0L0 2h4zm0 5L0 3h4z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 12px;
            padding-right: 35px;
        }

        .refresh-button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-50%) rotate(180deg);
        }

        .file-upload-section {
            background: #f8f9fa;
            padding: 5px 20px;
            border-bottom: 1px solid #e1e5e9;
            max-height: 100px;
            overflow: hidden;
        }

        .file-uploads-container {
            display: flex;
            gap: 14px;
            align-items: stretch;
            flex-wrap: nowrap;
            height: 100%;
        }

        .left-upload-group {
            flex: 1 1 50%;
            max-width: 50%;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 12px;
            height: 100%;
        }

        .left-upload-group .current-file {
            width: auto;
            flex: 1 1 0;
            min-width: 0;
        }

        .right-prompt-group {
            flex: 1 1 50%;
            max-width: 50%;
            height: 100%;
            display: flex;
        }

        .upload-square {
            width: 72px;
            height: 72px;
            background: #fff;
            border: 1px solid #e1e5e9;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            transition: box-shadow .2s ease, border-color .2s ease;
            user-select: none;
        }

        .upload-square:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-color: #cfd6dd; }
        .upload-square.no-file-state { opacity: .5; border-style: dashed; }

        .upload-square .icon-btn { position: absolute; right: 6px; bottom: 6px; }
        .upload-square .file-icon { font-size: 28px; }

        .prompt-panel {
            flex: 1 1 auto;
            background: #fff;
            border: 1px solid #e1e5e9;
            border-radius: 12px;
            padding: 10px 12px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            height: 100%;
            overflow: hidden;
        }

        .prompt-panel .left { display: flex; gap: 10px; align-items: center; }
        .prompt-panel .file-icon { font-size: 22px; }
        .prompt-panel .file-title { font-size: 13px; font-weight: 700; color: #2c3e50; }

        .icon-btn {
            background: transparent;
            border: 1px solid #e1e5e9;
            color: #667eea;
            width: 34px;
            height: 34px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 16px;
        }

        .icon-btn:hover {
            border-color: #667eea;
            background: rgba(102,126,234,0.08);
        }

        .custom-prompt-section { display: none; }

        .custom-prompt-section label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #5a6c7d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        #promptEditor {
            width: 100%;
            min-height: 240px;
            resize: vertical;
            padding: 10px 12px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.5;
            font-family: inherit;
        }

        .prompt-preview {
            font-size: 13px;
            color: #5a6c7d;
            line-height: 1.45;
            max-height: 6.2em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
        }

        .file-upload-wrapper {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .file-type-label {
            font-size: 12px;
            font-weight: 600;
            color: #5a6c7d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .current-file {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 12px;
            padding: 8px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            min-height: 60px;
        }

        .current-file:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .file-title-section {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }

        .file-icon {
            font-size: 18px;
            opacity: 0.8;
        }

        .file-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1 1 auto;
            min-width: 0;
        }

        .file-title {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
            max-width: 100%;
        }

        .file-status { display: none; }

        .change-file-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input {
            position: absolute;
            left: -9999px;
        }

        .change-file-btn {
            background: transparent;
            color: #667eea;
            border: 1px solid #667eea;
            width: 28px;
            height: 28px;
            padding: 0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .modal-save-btn {
            width: auto;
            min-width: 110px;
            height: 36px;
            padding: 0 18px;
        }

        .modal-cancel-btn {
            width: auto;
            min-width: 110px;
            height: 36px;
            padding: 0 18px;
        }

        .change-file-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.2);
        }

        .remove-file-btn {
            background: transparent;
            color: #e74c3c;
            border: 1px solid #e74c3c;
            padding: 6px 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-file-btn:hover {
            background: #e74c3c;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(231, 76, 60, 0.2);
        }

        .no-file-state {
            opacity: 0.6;
            border-style: dashed;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            min-height: 0;
        }

        .analyze-center {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            background: #f8f9fa;
        }

        .analyze-center.hidden {
            display: none;
        }

        .analyze-table-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .analyze-table-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
        }

        .chat-interface {
            display: none;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            min-height: 0;
        }

        .chat-interface.active {
            display: flex;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            overflow-x: hidden;
            background: #f8f9fa;
            min-height: 0;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.bot {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.6;
            word-wrap: break-word;
            font-size: 14px;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.bot .message-content {
            background: white;
            color: #333;
            border: 1px solid #e1e5e9;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .message-content h1, .message-content h2, .message-content h3 {
            margin: 12px 0 8px 0;
            color: #2c3e50;
            line-height: 1.4;
        }

        .message-content h1 { 
            font-size: 18px; 
            margin-top: 0;
        }
        
        .message-content h2 { 
            font-size: 16px; 
            margin-top: 16px;
        }
        
        .message-content h3 { 
            font-size: 14px; 
            margin-top: 14px;
        }

        .message-content p {
            margin: 12px 0;
            line-height: 1.6;
        }

        .message-content h1 + p,
        .message-content h2 + p,
        .message-content h3 + p {
            margin-top: 8px;
        }

        .message-content ul, .message-content ol {
            margin: 16px 0;
            padding-left: 24px;
        }

        .message-content li {
            margin: 8px 0;
            line-height: 1.5;
            padding-left: 4px;
        }

        .message-content li strong {
            font-weight: 600;
            color: #2c3e50;
        }

        .message-content ul ul {
            margin: 8px 0 8px 0;
            padding-left: 32px;
        }

        .message-content ul ul li {
            margin: 4px 0;
            font-weight: normal;
        }

        .message-content li p {
            margin: 4px 0;
        }

        .message-content > p {
            padding-left: 0;
            margin-left: 0;
        }

        .message-content em {
            font-style: italic;
            color: #5a6c7d;
        }

        .message-content code {
            background: #f1f1f1;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .message-content blockquote {
            margin: 16px 0;
            padding: 8px 16px;
            border-left: 4px solid #667eea;
            background: #f8f9fa;
            font-style: italic;
        }

        .typing-indicator {
            display: none;
            padding: 10px 16px;
            background: white;
            border-radius: 18px;
            border-bottom-left-radius: 5px;
            border: 1px solid #e1e5e9;
            max-width: 80px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            background: #999;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .chat-input {
            padding: 20px;
            background: white;
            border-top: 1px solid #e1e5e9;
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 25px;
            outline: none;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .message-input:focus {
            border-color: #667eea;
        }

        .send-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
        }

        .send-button:hover {
            transform: scale(1.05);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            background: #ff4757;
            color: white;
            padding: 10px;
            text-align: center;
            font-size: 14px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .success-message {
            background: #2ed573;
            color: white;
            padding: 10px;
            text-align: center;
            font-size: 14px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 20px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            position: relative;
        }

        .modal-content.wide {
            width: 80vw;
            max-width: 1200px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .close-modal:hover {
            color: #333;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .data-table th,
        .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .data-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .pdf-preview {
            width: 100%;
            height: 70vh;
            border: none;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .docx-preview {
            width: 100%;
            height: 70vh;
            overflow: auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 16px;
            color: #333;
            line-height: 1.5;
        }

        .json-view {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow: auto;
        }

        .chat-messages::-webkit-scrollbar,
        .modal-content::-webkit-scrollbar,
        .json-view::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track,
        .modal-content::-webkit-scrollbar-track,
        .json-view::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .chat-messages::-webkit-scrollbar-thumb,
        .modal-content::-webkit-scrollbar-thumb,
        .json-view::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover,
        .modal-content::-webkit-scrollbar-thumb:hover,
        .json-view::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        @media (max-width: 768px) {
            .file-uploads-container {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .analysis-selector {
                left: 10px;
                flex-direction: column;
                gap: 4px;
            }
            
            .analysis-dropdown {
                min-width: 160px;
                font-size: 10px;
                padding: 6px 12px;
            }
            
            .current-file {
                padding: 8px 16px;
            }
            
            .file-title {
                font-size: 12px;
            }
            
            .change-file-btn {
                padding: 4px 8px;
                font-size: 10px;
            }
            
            .analyze-table-btn {
                padding: 16px 32px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="analysis-selector">
                <select class="analysis-dropdown" id="analysisDropdown">
                    <option value="rate-risk-management">Rate Risk Management</option>
                    <option value="net-interest-margin" selected>Net Interest Margin</option>
                    <option value="forecast-kri">Forecast KRI</option>
                    <option value="competitive-kri">Competitive KRI</option>
                </select>
                <label class="docs-toggle" title="Append documentation context">
                    <input type="checkbox" id="addDocsCheckbox" />
                    Add docs
                </label>
            </div>
            <div class="model-selector">
                <select class="model-dropdown" id="modelDropdown" title="Select GPT model">
                    <option value="gpt-4.1-mini" selected>gpt-4.1-mini</option>
                    <option value="gpt-4.1">gpt-4.1</option>
                    <option value="gpt-4o">gpt-4o</option>
                    <option value="gpt-4o-mini">gpt-4o-mini</option>
                    <option value="gpt-5">gpt-5</option>
                </select>
            </div>
            <button class="refresh-button" id="refreshButton" title="Reset Page">🔄</button>
        </div>
        
        <div class="file-upload-section">
            <div class="file-uploads-container">
                <div class="left-upload-group">
                    <div class="current-file" id="currentCsvFile" title="Click to preview CSV">
                        <div class="file-title-section">
                            <div class="file-icon">📊</div>
                            <div class="file-details">
                                <h4 class="file-title" id="csvFileName">sample_rate_shock.csv</h4>
                                <div class="file-status" id="csvStatus">Active</div>
                            </div>
                        </div>
                        <div class="change-file-wrapper">
                            <div class="file-input-wrapper">
                                <input type="file" id="csvFileInput" class="file-input" accept=".csv,.xlsx,.json">
                                <label for="csvFileInput" class="change-file-btn" title="Change CSV">
                                    <span>📄</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="current-file no-file-state" id="currentPdfFile" title="Click to preview document">
                        <div class="file-title-section">
                            <div class="file-icon">📄</div>
                            <div class="file-details">
                                <h4 class="file-title" id="pdfFileName">No document loaded</h4>
                                <div class="file-status" id="pdfStatus">Optional</div>
                            </div>
                        </div>
                        <div class="change-file-wrapper">
                            <div class="file-input-wrapper">
                                <input type="file" id="pdfFileInput" class="file-input" accept=".pdf,.docx">
                                <label for="pdfFileInput" class="change-file-btn" title="Change file">
                                    <span>📄</span>
                                </label>
                            </div>
                            <button class="remove-file-btn" id="removePdfBtn" title="Remove PDF" style="display:none;">✕</button>
                        </div>
                    </div>
                </div>

                <div class="right-prompt-group">
                    <div class="prompt-panel">
                        <div class="left">
                            <div class="file-icon">📝</div>
                            <div>
                                <div class="file-title">Prompt</div>
                                <div class="prompt-preview" id="promptPreview">Edit the analysis prompt…</div>
                            </div>
                        </div>
                        <div style="margin-left:auto;">
                            <button class="icon-btn" id="editPromptBtn" title="Edit prompt">✎</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="custom-prompt-section">
                <label for="promptEditor">Prompt</label>
                <textarea id="promptEditor" placeholder="Customize the analysis prompt..."></textarea>
            </div>
        </div>
        
        <div class="main-content">
            <div class="analyze-center" id="analyzeCenter">
                <button class="analyze-table-btn" id="analyzeTableBtn">
                    <span>🔍</span>
                    Analyze Data
                </button>
            </div>
            
            <div class="chat-interface" id="chatInterface">
                <div class="chat-messages" id="chatMessages"></div>
                
                <div class="chat-input">
                    <div class="input-container">
                        <input 
                            type="text" 
                            class="message-input" 
                            id="messageInput" 
                            placeholder="Ask about your data or BankersGPS documentation..."
                            maxlength="1000"
                        >
                        <button class="send-button" id="sendButton">
                            ➤
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Data Preview</h3>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const csvFileInput = document.getElementById('csvFileInput');
        const pdfFileInput = document.getElementById('pdfFileInput');
        const currentCsvFile = document.getElementById('currentCsvFile');
        const currentPdfFile = document.getElementById('currentPdfFile');
        const csvFileName = document.getElementById('csvFileName');
        const pdfFileName = document.getElementById('pdfFileName');
        const csvStatus = document.getElementById('csvStatus');
        const pdfStatus = document.getElementById('pdfStatus');
        const removePdfBtn = document.getElementById('removePdfBtn');
        const analyzeCenter = document.getElementById('analyzeCenter');
        const chatInterface = document.getElementById('chatInterface');
        const analyzeTableBtn = document.getElementById('analyzeTableBtn');
        const modalOverlay = document.getElementById('modalOverlay');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const closeModal = document.getElementById('closeModal');
        const modalContent = document.querySelector('.modal-content');
        const refreshButton = document.getElementById('refreshButton');
        const analysisDropdown = document.getElementById('analysisDropdown');
        const modelDropdown = document.getElementById('modelDropdown');
        const promptEditor = document.getElementById('promptEditor');
        const promptPreview = document.getElementById('promptPreview');
        const editPromptBtn = document.getElementById('editPromptBtn');

        let currentCsvData = null;
        let currentPdfData = null;
        let currentDataType = 'csv';
        let activeAnalysis = 'net-interest-margin';
        let includeDocs = false;
        let selectedModel = 'gpt-4.1-mini';
        // Conversation state: stores chat messages for this analysis session
        let conversation = [];
        let initialFullPrompt = null;

        // Simplified analysis configuration
        const analysisConfig = {
            'rate-risk-management': {
                name: 'Rate Risk Management',
                csvFile: 'sample_rate_shock.csv',
                pdfFile: null,
                useDocuments: false,
                prompt: `Using only the uploaded file and no external sources, write a clear, concise, executive-ready narrative that covers every rate shock scenario from -400 to +400. Surface the most important insights on how rate movements affect the key risk metrics, call out the most adverse and favorable scenarios, and explain the drivers you can see in the asset and liability categories. Flag any risk assumptions that merit follow-up.

CRITICAL DATA UNITS: All balance figures appear in thousands (000s); treat scenario labels such as "-400bp" as basis-point changes and percentage columns as already scaled. When citing dollars, restate them in full dollar terms for clarity.

Note: Focus on Economic Value of Equity (EVE) sensitivity — how the economic value of assets and liabilities shifts as rates move, not simple balance totals. Discuss overall rate sensitivity and any asymmetry across shocks, explicitly name the most adverse and most favorable scenarios with both % and $ EVE changes, and explain which balance-sheet segments drive the pattern (duration/convexity, repricing timing, rate floors, deposit betas). Highlight if results taper or reverse at higher positive shocks as liability costs or floors bite. Keep the format primarily narrative with minimal headings, bold the critical figures, state "Not available" when data is missing, and close with a brief "Summary" paragraph followed by 3–5 bullets titled "Assumptions to Review" tied directly to observed patterns.

Note: Focus on Rate Risk Management FROM THE CENTER POINT— how the balance sheet's economic value changes with interest rates`
            },
            'net-interest-margin': {
                name: 'Net Interest Margin',
                csvFile: 'sample_net_intrest.csv',
                pdfFile: null,
                useDocuments: false,
                prompt: `Using only the uploaded file and no external sources, write a clear, concise and easy-to-read narrative geared towards an executive audience. The format should be PRIMARILY narrative with section headers and paragraph structure. Keep the discussion high-level and directional.
 
Begin immediately with findings—no introductory paragraph about what the analysis is or does.
 
The objective of this interest rate risk analysis is to give priority to identifying DECLINES in net interest income and margin and secondarily, to identifying increases in net interest income and margin. The narrative should identify key insights across all rate shock scenarios from -400 to +400. Describe the outcomes in general terms FROM THE CENTER POINT: whether net interest margin expands or contracts, whether the impact is material or modest, and which direction shows more favorable or adverse results from the center point.
 
Include information on the asset and liability categories shown that are having the greatest impact on the results and suggest POSSIBLE risk assumptions to look into that may contribute to the results.
Note: The uploaded file is a Net Interest Income rate shock analysis on a static balance sheet with no volume changes on assets or liabilities. DO NOT reference risks associated with a static balance sheet since this is a regulatory compliant report. DO NOT comment on asymmetry of results.
 
CRITICAL DATA UNITS: ALL dollar amounts in ALL columns are in thousands (000s) - apply this scaling to every numeric column except rate scenarios (like "-400bp") and percentage fields (marked with "%"). Example: 29098 in any dollar column = $29.1 million.`
             },
            'forecast-kri': {
                name: 'Forecast Key Risk Indicators',
                csvFile: 'gps_kri_forecast.csv',
                pdfFile: null,
                useDocuments: true,
                prompt: `Using only the uploaded file and no external sources, craft a concise, executive-level narrative that interprets forward-looking key risk indicators across the CAELS dimensions through the three-year forecast horizon. Highlight the directional shifts, inflection points, and any movement toward or away from the stated risk limits.

CRITICAL DATA UNITS: "Low" and "High" columns define the acceptable tolerance band for each indicator. Historical (2023–2024) and Q2 2025 values are actuals, while 2025–2027 columns are system-generated forecasts. Treat blank cells as missing data and call them out when relevant.

Note: Keep the response primarily narrative and insight-led. Use two short sections titled "Risk Trend Analysis" and "Strategic Risk Implications" to organize the story, but avoid restating the table. Bold the pivotal figures, reference the "Risk Trend" / "Risk Outlook" signals where they reinforce the data, and flag any stretch goals or emerging pressures management should prioritize.`
            },
            'competitive-kri': {
                name: 'Competitive Key Risk Indicators',
                csvFile: 'gps_kri_competitive.csv',
                pdfFile: null,
                useDocuments: true,
                prompt: `Using only the uploaded file and no external sources, compose an executive-level narrative that compares BankersGPS performance to the peer benchmarks across the competitive KRI set. Call out where the institution leads, lags, or clusters with peers, and quantify the advantage or gap using the actual values provided.

CRITICAL DATA UNITS: Each metric is paired with peer quartiles (P25, Median, P75) or percentile rankings. Treat percentage values as already scaled, restate dollar figures in full dollars for clarity, and flag data points marked as "Not available" if they limit the comparison.

Note: Keep the response narrative and insight-led. Organize it into two brief sections titled "Competitive Risk Analysis" and "Strategic Positioning," bold the pivotal numbers, emphasize deltas versus peer medians/quartiles, and outline immediate actions or watch items suggested by the data without restating the entire table.`
            }
        };

        // Initialize on load
        loadActiveAnalysisData();
        loadDefaultPromptForAnalysis();
        updatePromptPreview();

        // Dropdown change handler
        analysisDropdown.addEventListener('change', (e) => {
            const newAnalysis = e.target.value;
            if (newAnalysis !== activeAnalysis) {
                switchAnalysis(newAnalysis);
            }
        });

        // Docs toggle handler
        const addDocsCheckbox = document.getElementById('addDocsCheckbox');
        addDocsCheckbox.addEventListener('change', (e) => {
            includeDocs = e.target.checked;
            console.log(`[UI] Add docs toggled: ${includeDocs}`);
        });

        // Model dropdown handler
        modelDropdown.addEventListener('change', (e) => {
            selectedModel = e.target.value || 'gpt-4.1-mini';
            console.log(`[UI] Model selected: ${selectedModel}`);
        });

        function switchAnalysis(analysisId) {
            activeAnalysis = analysisId;
            resetToInitialState();
            loadActiveAnalysisData();
            loadDefaultPromptForAnalysis();
            updatePromptPreview();
        }

        function getDefaultPromptForAnalysis() {
            const config = analysisConfig[activeAnalysis] || {};
            return config.prompt || '';
        }

        function loadDefaultPromptForAnalysis() {
            try {
                promptEditor.value = getDefaultPromptForAnalysis();
            } catch (_) {
                promptEditor.value = '';
            }
        }

        function updatePromptPreview() {
            const text = (promptEditor.value || '').trim();
            promptPreview.textContent = text ? text : 'Edit the analysis prompt…';
        }

        editPromptBtn.addEventListener('click', () => {
            openPromptModal();
        });

        function openPromptModal() {
            modalTitle.textContent = 'Edit Prompt';
            modalContent.classList.add('wide');
            modalBody.innerHTML = '';
            promptEditor.style.display = 'block';
            modalBody.appendChild(promptEditor);
            
            const actions = document.createElement('div');
            actions.style.marginTop = '12px';
            actions.style.display = 'flex';
            actions.style.gap = '8px';
            
            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'Save';
            saveBtn.className = 'change-file-btn modal-save-btn';
            saveBtn.addEventListener('click', () => {
                updatePromptPreview();
                modalOverlay.style.display = 'none';
            });
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.className = 'remove-file-btn modal-cancel-btn';
            cancelBtn.addEventListener('click', () => closeModal.click());
            
            actions.appendChild(saveBtn);
            actions.appendChild(cancelBtn);
            modalBody.appendChild(actions);
            
            modalOverlay.style.display = 'flex';
        }

        closeModal.addEventListener('click', () => {
            modalOverlay.style.display = 'none';
        });

        refreshButton.addEventListener('click', () => {
            try {
                window.location.reload();
            } catch (err) {
                console.warn('Hard reload failed; performing soft reset.', err);
                analysisDropdown.value = 'net-interest-margin';
                activeAnalysis = 'net-interest-margin';
                addDocsCheckbox.checked = false;
                includeDocs = false;
                modelDropdown.value = 'gpt-4.1-mini';
                selectedModel = 'gpt-4.1-mini';

                promptEditor.value = '';
                resetToInitialState();
                loadActiveAnalysisData();
                loadDefaultPromptForAnalysis();
                updatePromptPreview();
            }
        });

        function resetToInitialState() {
            analyzeCenter.classList.remove('hidden');
            chatInterface.classList.remove('active');
            chatMessages.innerHTML = '';
            messageInput.value = '';
            messageInput.disabled = false;
            sendButton.disabled = false;
            conversation = [];
            initialFullPrompt = null;
            
            document.querySelectorAll('.error-message, .success-message').forEach(msg => {
                if (msg.parentNode) msg.remove();
            });
        }

        async function loadActiveAnalysisData() {
            const config = analysisConfig[activeAnalysis];
            
            if (isUserUploadedData()) {
                console.log('User data already loaded, keeping current data');
                return;
            }
            
            // Load CSV data
            try {
                const csvResponse = await fetch(`./assets/${config.csvFile}`);
                
                if (csvResponse.ok) {
                    const csvText = await csvResponse.text();
                    currentCsvData = parseAndPreprocessCSV(csvText, activeAnalysis);
                    currentDataType = 'csv';
                    csvFileName.textContent = config.csvFile;
                    csvStatus.textContent = 'Active (Sample)';
                    currentCsvFile.classList.remove('no-file-state');
                    currentCsvFile.style.borderColor = '#e1e5e9';
                    
                    try {
                        const colCount = Array.isArray(currentCsvData) && currentCsvData[0] ? Object.keys(currentCsvData[0]).length : 0;
                        console.log(`[CSV] Sample loaded: ${config.csvFile} (rows=${Array.isArray(currentCsvData) ? currentCsvData.length : 0}, cols=${colCount})`);
                    } catch (_) {}
                } else {
                    showError(`${config.csvFile} not found in assets folder`);
                    csvStatus.textContent = 'Missing';
                    currentCsvFile.classList.add('no-file-state');
                    console.warn(`[CSV] Sample missing: ${config.csvFile}`);
                }
            } catch (error) {
                console.error('Error loading CSV data:', error);
                showError('Could not load CSV data');
                csvStatus.textContent = 'Error';
                currentCsvFile.classList.add('no-file-state');
            }

            // Load PDF data
            const currentPdfName = pdfFileName.textContent;
            if (currentPdfName && !currentPdfName.includes('sample_') && !currentPdfName.includes('No document')) {
                console.log('User PDF already loaded, keeping current PDF');
                return;
            }

            if (config.pdfFile) {
                try {
                    const pdfResponse = await fetch(`./assets/${config.pdfFile}`);
                    
                    if (pdfResponse.ok) {
                        const pdfBlob = await pdfResponse.blob();
                        currentPdfData = pdfBlob;
                        pdfFileName.textContent = config.pdfFile;
                        pdfStatus.textContent = 'Active (Sample)';
                        currentPdfFile.classList.remove('no-file-state');
                        currentPdfFile.style.borderColor = '#e1e5e9';
                        removePdfBtn.style.display = 'flex';
                        console.log(`[PDF] Sample loaded: ${config.pdfFile} (size=${pdfBlob.size} bytes)`);
                    } else {
                        currentPdfData = null;
                        pdfFileName.textContent = 'PDF or DOCX';
                        pdfStatus.textContent = 'Optional';
                        currentPdfFile.classList.add('no-file-state');
                        currentPdfFile.style.borderColor = '#e1e5e9';
                        removePdfBtn.style.display = 'none';
                        console.warn(`[PDF] Sample not found: ${config.pdfFile}`);
                    }
                } catch (error) {
                    console.error('Error loading PDF data:', error);
                    currentPdfData = null;
                    pdfFileName.textContent = 'PDF or DOCX';
                    pdfStatus.textContent = 'Optional';
                    currentPdfFile.classList.add('no-file-state');
                    removePdfBtn.style.display = 'none';
                }
            } else {
                currentPdfData = null;
                pdfFileName.textContent = 'PDF or DOCX';
                pdfStatus.textContent = 'Optional';
                currentPdfFile.classList.add('no-file-state');
                removePdfBtn.style.display = 'none';
                console.log('[PDF] No sample PDF configured for this analysis');
            }
        }

        function parseAndPreprocessCSV(csvText, analysisType) {
            try {
                const data = parseCSVRobust(csvText, analysisType);
                
                if (analysisType.includes('kri')) {
                    return preprocessKRIData(data, analysisType);
                }
                
                return data;
                
            } catch (error) {
                console.error('CSV parsing error:', error);
                throw new Error(`CSV parsing failed: ${error.message}`);
            }
        }

        function preprocessKRIData(data, analysisType) {
            if (!data || data.length === 0) return data;
            
            console.log('Preprocessing KRI data...');
            
            const processedData = data.map(row => {
                const cleanRow = {};
                
                Object.keys(row).forEach(key => {
                    let cleanKey = key.trim()
                        .replace(/\s+/g, ' ')
                        .replace(/[^\w\s%()/-]/g, '')
                        .trim();
                    
                    if (cleanKey.toLowerCase().includes('risk status')) {
                        cleanKey = 'Risk Status';
                    } else if (cleanKey.toLowerCase().includes('risk trend')) {
                        cleanKey = 'Risk Trend';
                    } else if (cleanKey.toLowerCase().includes('risk outlook')) {
                        cleanKey = 'Risk Outlook';
                    } else if (cleanKey.toLowerCase().includes('current')) {
                        cleanKey = 'Current Value';
                    } else if (cleanKey.toLowerCase().includes('peer') && cleanKey.toLowerCase().includes('median')) {
                        cleanKey = 'Peer Median';
                    }
                    
                    let value = row[key];
                    if (typeof value === 'string') {
                        value = value.trim();
                        
                        if (value.toLowerCase() === 'low' || value.toLowerCase() === 'low risk') {
                            value = 'Low';
                        } else if (value.toLowerCase() === 'moderate' || value.toLowerCase() === 'moderate risk') {
                            value = 'Moderate';
                        } else if (value.toLowerCase() === 'high' || value.toLowerCase() === 'high risk') {
                            value = 'High';
                        }
                        
                        if (value.toLowerCase() === 'increasing') {
                            value = 'Increasing';
                        } else if (value.toLowerCase() === 'decreasing') {
                            value = 'Decreasing';
                        } else if (value.toLowerCase() === 'stable') {
                            value = 'Stable';
                        } else if (value.toLowerCase() === 'fluctuating') {
                            value = 'Fluctuating';
                        }
                        
                        if (value.match(/^\d+\.?\d*%$/)) {
                            const numValue = parseFloat(value.replace('%', ''));
                            if (!isNaN(numValue)) {
                                cleanRow[cleanKey + ' (%)'] = numValue;
                                cleanRow[cleanKey] = value;
                                return;
                            }
                        }
                    }
                    
                    cleanRow[cleanKey] = value;
                });
                
                return cleanRow;
            });
            
            const metadata = {
                dataType: 'KRI',
                analysisType: analysisType,
                categories: extractKRICategories(processedData),
                riskMetrics: extractRiskMetrics(processedData),
                timeHorizon: analysisType.includes('forecast') ? 'Forecast (3 years)' : 'Current vs Peers',
                processingNotes: 'Data normalized for risk levels (Low/Moderate/High) and trends (Increasing/Decreasing/Stable/Fluctuating)'
            };
            
            console.log('KRI preprocessing complete:', metadata);
            
            processedData.metadata = metadata;
            return processedData;
        }

        function isUserUploadedData() {
            const fileName = csvFileName.textContent.toLowerCase();
            return !fileName.includes('sample_') && 
                !fileName.includes('gps_') && 
                !fileName.includes('demo') && 
                !fileName.includes('example') &&
                fileName !== 'no csv loaded';
        }

        function extractKRICategories(data) {
            const categories = new Set();
            
            data.forEach(row => {
                Object.keys(row).forEach(key => {
                    const lowerKey = key.toLowerCase();
                    if (lowerKey.includes('capital')) categories.add('Capital');
                    if (lowerKey.includes('asset') || lowerKey.includes('credit') || lowerKey.includes('npl') || lowerKey.includes('texas')) categories.add('Asset Quality');
                    if (lowerKey.includes('earnings') || lowerKey.includes('nim') || lowerKey.includes('roa') || lowerKey.includes('roe')) categories.add('Earnings');
                    if (lowerKey.includes('liquid') || lowerKey.includes('funding')) categories.add('Liquidity');
                    if (lowerKey.includes('rate') || lowerKey.includes('market') || lowerKey.includes('duration')) categories.add('Market Risk');
                });
            });
            
            return Array.from(categories);
        }

        function extractRiskMetrics(data) {
            const metrics = new Set();
            
            data.forEach(row => {
                Object.keys(row).forEach(key => {
                    if (key !== 'Risk Status' && key !== 'Risk Trend' && key !== 'Risk Outlook') {
                        metrics.add(key);
                    }
                });
            });
            
            return Array.from(metrics).slice(0, 10);
        }

        // File upload handling
        csvFileInput.addEventListener('change', (e) => handleFileUpload(e, 'csv'));
        pdfFileInput.addEventListener('change', (e) => handleFileUpload(e, 'pdf'));
        
        removePdfBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            removePdf();
        });

        function removePdf() {
            currentPdfData = null;
            pdfFileName.textContent = 'PDF or DOCX';
            pdfStatus.textContent = 'Optional';
            currentPdfFile.classList.add('no-file-state');
            removePdfBtn.style.display = 'none';
            pdfFileInput.value = '';
            showSuccess('Document removed successfully');
        }
        
        document.querySelectorAll('.change-file-wrapper').forEach(wrapper => {
            wrapper.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        });
        
        async function handleFileUpload(event, fileType) {
            const file = event.target.files[0];
            if (!file) return;

            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            if (fileType === 'csv') {
                if (!['csv', 'xlsx', 'json'].includes(fileExtension)) {
                    showError('Please upload a CSV, Excel (.xlsx), or JSON file');
                    return;
                }
            } else if (fileType === 'pdf') {
                if (!['pdf', 'docx'].includes(fileExtension)) {
                    showError('Please upload a PDF or DOCX file');
                    return;
                }
            }

            try {
                if (fileType === 'csv') {
                    let data;
                    
                    switch (fileExtension) {
                        case 'csv':
                            const fileContent = await readFileWithEncodingDetection(file);
                            data = parseAndPreprocessCSV(fileContent, activeAnalysis);
                            break;
                        case 'json':
                            const jsonContent = await readFileAsText(file);
                            data = JSON.parse(jsonContent);
                            break;
                        case 'xlsx':
                            showError('Excel files require additional processing. Please convert to CSV for now.');
                            return;
                    }

                    currentCsvData = data;
                    currentDataType = fileExtension;
                    csvFileName.textContent = file.name;
                    csvStatus.textContent = 'Active (User Data)';
                    currentCsvFile.classList.remove('no-file-state');
                    currentCsvFile.style.borderColor = '#28a745';
                    
                    showSuccess(`${file.name} loaded successfully! Analysis will use your institution's data.`);
                    try {
                        const colCount = Array.isArray(currentCsvData) && currentCsvData[0] ? Object.keys(currentCsvData[0]).length : 0;
                        console.log(`[CSV] User file loaded: ${file.name} (rows=${Array.isArray(currentCsvData) ? currentCsvData.length : 0}, cols=${colCount})`);
                    } catch (_) {}
                } else if (fileType === 'pdf') {
                    currentPdfData = file;
                    pdfFileName.textContent = file.name;
                    pdfStatus.textContent = 'Active (User Data)';
                    currentPdfFile.classList.remove('no-file-state');
                    currentPdfFile.style.borderColor = '#28a745';
                    removePdfBtn.style.display = 'flex';
                    
                    showSuccess(`${file.name} loaded successfully!`);
                    console.log(`[DOC] User file loaded: ${file.name} (size=${file.size} bytes)`);
                }
                
            } catch (error) {
                console.error('File processing error:', error);
                showError('Error processing file. Please check the format.');
            }
        }

        async function readFileWithEncodingDetection(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    let content = e.target.result;
                    
                    if (content.includes('�')) {
                        console.log('Encoding issue detected, trying alternative method...');
                        
                        const reader2 = new FileReader();
                        reader2.onload = function(e2) {
                            resolve(e2.target.result);
                        };
                        reader2.onerror = reject;
                        reader2.readAsText(file, 'ISO-8859-1');
                    } else {
                        resolve(content);
                    }
                };
                
                reader.onerror = reject;
                reader.readAsText(file, 'UTF-8');
            });
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        function parseCSVRobust(csvText, analysisType) {
            try {
                const normalized = csvText.replace(/\r\n?/g, '\n').trim();
                const lines = normalized.split('\n');
                
                if (lines.length === 0) {
                    throw new Error('Empty CSV file');
                }
                
                const rawData = parseRawCSV(lines);

                const a = (analysisType || '').toLowerCase();
                if (a.includes('net-interest') || a.includes('rate-risk')) {
                    const normalizedData = normalizeBankOrientation(rawData);
                    try {
                        const headers = Object.keys(normalizedData[0] || {});
                        console.log('[CSV] Normalized headers:', headers.join(', '));
                    } catch (_) {}
                    return normalizedData;
                }

                return rawData;
                
            } catch (error) {
                console.error('CSV parsing error:', error);
                throw new Error(`CSV parsing failed: ${error.message}`);
            }
        }

        function parseRawCSV(lines) {
            const headerLineRaw = lines[0] || '';
            
            const commaCount = (headerLineRaw.match(/,/g) || []).length;
            const tabCount = (headerLineRaw.match(/\t/g) || []).length;
            const delimiter = tabCount > commaCount ? '\t' : ',';

            const splitRespectingQuotes = (line) => {
                const out = [];
                let current = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const ch = line[i];
                    if (ch === '"') {
                        if (inQuotes && line[i + 1] === '"') {
                            current += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (!inQuotes && ch === delimiter) {
                        out.push(current);
                        current = '';
                    } else {
                        current += ch;
                    }
                }
                out.push(current);
                return out.map(v => v.replace(/^\uFEFF/, '').trim());
            };

            const firstRowValues = splitRespectingQuotes(headerLineRaw).map(h => h.replace(/^"|"$/g, '').trim());
            const rateShockPattern = /^[+-]?\d+\s*bp$|^current$/i;
            const rateScenarioCount = firstRowValues.filter(val => rateShockPattern.test(val)).length;

            console.log('CSV PARSING - First row:', firstRowValues);
            console.log('Rate scenarios found:', rateScenarioCount);

            if (rateScenarioCount >= 3) {
                console.log('Treating as headerless CSV - first row contains data');
                
                const columnNames = firstRowValues.map((_, index) => `col_${index}`);
                console.log('Synthetic columns:', columnNames);
                
                const allLines = lines.filter(line => line.trim().length > 0);
                
                const result = allLines.map((line) => {
                    const values = splitRespectingQuotes(line);
                    const row = {};
                    columnNames.forEach((colName, index) => {
                        row[colName] = (values[index] ?? '').replace(/^"|"$/g, '').trim();
                    });
                    return row;
                });
                
                console.log('Parsed result sample:', result[0]);
                return result;
            } else {
                console.log('Standard CSV with headers');
                const headers = firstRowValues;
                const dataRows = lines.slice(1).filter(line => line.trim().length > 0);

                return dataRows.map((line) => {
                    const values = splitRespectingQuotes(line);
                    const row = {};
                    headers.forEach((header, index) => {
                        const key = header || `Column_${index}`;
                        row[key] = (values[index] ?? '').replace(/^"|"$/g, '').trim();
                    });
                    return row;
                });
            }
        }

        function normalizeBankOrientation(data) {
            if (!Array.isArray(data) || data.length === 0) return data;

            const rateShockPattern = /^[+-]?\d+\s*bp$|^current$/i;
            const headers = Object.keys(data[0] || {});
            const firstKey = headers[0] || '';

            console.log('Normalize Debug - Original headers:', headers);
            console.log('Normalize Debug - First row:', data[0]);

            const sampleCount = Math.min(10, data.length);
            let bpMatches = 0;
            for (let i = 0; i < sampleCount; i++) {
                const v = String(data[i][firstKey] || '').trim();
                if (rateShockPattern.test(v)) bpMatches++;
            }
            const firstColHasRateScenarios = bpMatches >= Math.max(2, Math.ceil(sampleCount * 0.6));

            if (firstColHasRateScenarios) {
                console.log('Data is already in correct format');
                return data;
            }

            const firstRow = data[0];
            const firstRowValues = headers
                .filter(h => h !== 'Column_0')
                .map(header => String(firstRow[header] || '').trim());
            const firstRowHasRateScenarios = firstRowValues.filter(val => rateShockPattern.test(val)).length >= 3;

            console.log('First row values (excluding last):', firstRowValues);
            console.log('First row has rate scenarios:', firstRowHasRateScenarios);

            if (firstRowHasRateScenarios) {
                console.log('Need to transpose - rate scenarios are in first row');
                return transposeCSVData(data);
            }

            const headersHaveRateScenarios = headers.some(h => rateShockPattern.test(h));
            if (headersHaveRateScenarios) {
                console.log('Headers have rate scenarios, transposing');
                return transposeCSVData(data);
            }

            if (headers.includes('bp') && headers[0] !== 'bp') {
                console.log('Moving bp column to first position');
                return data.map(row => {
                    const newRow = { bp: row.bp };
                    headers.forEach(key => {
                        if (key !== 'bp') newRow[key] = row[key];
                    });
                    return newRow;
                });
            }

            console.log('No changes needed');
            return data;
        }

        function transposeCSVData(originalData) {
            if (!originalData || originalData.length === 0) return originalData;

            console.log('REAL TRANSPOSE - Original structure:');
            console.log('Original headers:', Object.keys(originalData[0]));
            console.log('Original first row:', originalData[0]);
            console.log('Original data rows:', originalData.length);

            const originalHeaders = Object.keys(originalData[0]);
            const lastColumnName = originalHeaders[originalHeaders.length - 1];
            
            const rateScenarios = [];
            for (let i = 0; i < originalHeaders.length - 1; i++) {
                const headerName = originalHeaders[i];
                const scenarioValue = originalData[0][headerName];
                if (scenarioValue && String(scenarioValue).trim()) {
                    rateScenarios.push(String(scenarioValue).trim());
                }
            }
            
            const metricNames = [];
            for (let rowIndex = 1; rowIndex < originalData.length; rowIndex++) {
                const metricName = originalData[rowIndex][lastColumnName];
                if (metricName && String(metricName).trim()) {
                    metricNames.push(String(metricName).trim());
                }
            }

            const scenarioHeaderCandidate = originalData[0][lastColumnName] && String(originalData[0][lastColumnName]).trim();
            const scenarioHeaderName = scenarioHeaderCandidate || lastColumnName || 'bp';

            const filteredMetricNames = metricNames.filter(m => m.toLowerCase() !== String(scenarioHeaderName).toLowerCase());
            
            console.log('Rate scenarios extracted:', rateScenarios);
            console.log('Metric names extracted:', filteredMetricNames);
            
            const transposedData = [];
            
            for (let scenarioIndex = 0; scenarioIndex < rateScenarios.length; scenarioIndex++) {
                const scenario = rateScenarios[scenarioIndex];
                const newRow = {};
                newRow[scenarioHeaderName] = scenario;
                
                for (let metricIndex = 0; metricIndex < filteredMetricNames.length; metricIndex++) {
                    const metricName = filteredMetricNames[metricIndex];
                    
                    const sourceRowIndex = metricIndex + 1;
                    const sourceColumnName = originalHeaders[scenarioIndex];
                    
                    const value = originalData[sourceRowIndex] && originalData[sourceRowIndex][sourceColumnName] 
                        ? originalData[sourceRowIndex][sourceColumnName] 
                        : '';
                    
                    newRow[metricName] = value;
                }
                
                transposedData.push(newRow);
            }
            
            console.log('TRANSPOSED RESULT:');
            console.log('New headers:', Object.keys(transposedData[0] || {}));
            console.log('First row:', transposedData[0]);
            console.log('Second row:', transposedData[1]);
            console.log('Total rows:', transposedData.length);
            
            return transposedData;
        }

        function createMinimalDataBlock(data) {
            if (!Array.isArray(data) || data.length === 0) return 'DATASET: (no rows)';
            let block = `DATASET (${data.length} rows)\nCOLUMNS: ${Object.keys(data[0]).join(', ')}\n`;
            data.forEach((row, idx) => {
                block += `Row ${idx + 1}: ${JSON.stringify(row)}\n`;
            });
            return block;
        }

        // Modal functions
        currentCsvFile.addEventListener('click', () => showDataModal('csv'));
        currentPdfFile.addEventListener('click', () => showDataModal('pdf'));
        
        document.querySelectorAll('.file-input-wrapper label, #removePdfBtn, .change-file-btn, .remove-file-btn').forEach(el => {
            el.addEventListener('click', (e) => e.stopPropagation());
        });
        closeModal.addEventListener('click', hideDataModal);
        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) hideDataModal();
        });

        function showDataModal(fileType) {
            modalContent.classList.remove('wide');
            if (fileType === 'csv') {
                if (!currentCsvData) {
                    showError('No CSV data loaded');
                    return;
                }

                modalTitle.textContent = `${csvFileName.textContent} - Data Preview`;
                
                if (Array.isArray(currentCsvData) && currentCsvData.length > 0) {
                    modalBody.innerHTML = createTableHTML(currentCsvData);
                } else {
                    modalBody.innerHTML = `<div class="json-view">${JSON.stringify(currentCsvData, null, 2)}</div>`;
                }
            } else if (fileType === 'pdf') {
                if (!currentPdfData) {
                    showError('No document loaded');
                    return;
                }

                modalTitle.textContent = `${pdfFileName.textContent} - Document Preview`;
                
                const isPdf = (currentPdfData.type === 'application/pdf' || (currentPdfData.name || '').toLowerCase().endsWith('.pdf'));
                const isDocx = (currentPdfData.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || (currentPdfData.name || '').toLowerCase().endsWith('.docx'));

                if (isPdf) {
                    const pdfUrl = URL.createObjectURL(currentPdfData);
                    modalBody.innerHTML = `<iframe src="${pdfUrl}" class="pdf-preview" title="PDF Preview"></iframe>`;
                } else if (isDocx) {
                    modalBody.innerHTML = `<div class="docx-preview">Generating preview…</div>`;
                    (async () => {
                        try {
                            console.log('[PREVIEW] Uploading DOCX for preview:', currentPdfData.name, currentPdfData.type, currentPdfData.size);
                            const fd = new FormData();
                            fd.append('pdfFile', currentPdfData);
                            const resp = await fetch('/api/preview/docx', { method: 'POST', body: fd });
                            const data = await resp.json();
                            if (resp.ok && data.success) {
                                console.log('[PREVIEW] DOCX preview generated');
                                modalBody.innerHTML = `<div class="docx-preview">${data.html || 'No content'}</div>`;
                            } else {
                                console.warn('[PREVIEW] DOCX preview failed', data);
                                modalBody.innerHTML = `<div class="docx-preview">Could not render DOCX preview.</div>`;
                            }
                        } catch (e) {
                            console.error('[PREVIEW] DOCX preview error', e);
                            modalBody.innerHTML = `<div class="docx-preview">Error generating DOCX preview.</div>`;
                        }
                    })();
                } else {
                    modalBody.innerHTML = `<div class="docx-preview">Preview not available for this file type</div>`;
                }
            }
            
            modalOverlay.style.display = 'flex';
        }

        function hideDataModal() {
            modalOverlay.style.display = 'none';
            modalContent.classList.remove('wide');
            const iframe = modalBody.querySelector('iframe');
            if (iframe && iframe.src.startsWith('blob:')) {
                URL.revokeObjectURL(iframe.src);
            }
        }

        function createTableHTML(data) {
            if (!data || data.length === 0) return '<p>No data to display</p>';
            
            const headers = Object.keys(data[0]).filter(key => key !== 'metadata');
            const maxRows = 100;
            const displayData = data.slice(0, maxRows);
            
            let html = '<table class="data-table"><thead><tr>';
            headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            displayData.forEach(row => {
                html += '<tr>';
                headers.forEach(header => {
                    html += `<td>${row[header] || ''}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            
            if (data.length > maxRows) {
                html += `<p style="margin-top: 10px; color: #666;">Showing first ${maxRows} of ${data.length} rows</p>`;
            }
            
            if (data.metadata) {
                html += `<div style="margin-top: 20px; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                    <strong>Data Information:</strong><br>
                    Type: ${data.metadata.dataType}<br>
                    Analysis: ${data.metadata.analysisType}<br>
                    Categories: ${data.metadata.categories.join(', ')}<br>
                    Time Horizon: ${data.metadata.timeHorizon}
                </div>`;
            }
            
            return html;
        }

        // Analyze button
        analyzeTableBtn.addEventListener('click', startAnalysis);

        async function startAnalysis() {
            if (!currentCsvData && !currentPdfData) {
                showError('No data loaded to analyze');
                return;
            }

            analyzeCenter.classList.add('hidden');
            chatInterface.classList.add('active');

            await sendMessage('Analyze', false);
            messageInput.focus();
        }

        // Chat functions
        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = isUser ? escapeHtml(content) : formatBotResponse(content);
            
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatBotResponse(text) {
            let formatted = text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/^#### (.*$)/gm, '<h4>$1</h4>')
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/`([^`]+)`/g, '<code>$1</code>');

            formatted = formatted.replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>');

            const sections = formatted.split(/\n\n+/);
            
            return sections
                .map(section => {
                    section = section.trim();
                    if (!section) return '';
                    
                    if (section.includes('•') || section.match(/^[-*]\s/m)) {
                        return processBulletSection(section);
                    }
                    
                    if (section.startsWith('<h') || section.startsWith('<blockquote>')) {
                        return section;
                    }
                    
                    return `<p>${section.replace(/\n/g, ' ')}</p>`;
                })
                .join('');
        }
        
        function processBulletSection(section) {
            const lines = section.split('\n');
            let result = '';
            let inMainList = false;
            let inSubList = false;
            let currentMainItem = '';
            let subItems = [];
            
            for (let line of lines) {
                line = line.trim();
                
                if (line.match(/^[•*-]\s/)) {
                    if (inSubList && subItems.length > 0) {
                        currentMainItem += '<ul>' + subItems.map(item => `<li>${item}</li>`).join('') + '</ul>';
                        subItems = [];
                        inSubList = false;
                    }
                    
                    if (currentMainItem) {
                        result += `<li>${currentMainItem}</li>`;
                        currentMainItem = '';
                    }
                    
                    if (!inMainList) {
                        result = '<ul>';
                        inMainList = true;
                    }
                    
                    currentMainItem = line.replace(/^[•*-]\s/, '');
                    
                } else if (line.match(/^[•*-]\s/) && currentMainItem && !line.includes('<strong>')) {
                    if (!inSubList) {
                        inSubList = true;
                    }
                    subItems.push(line.replace(/^[•*-]\s/, ''));
                    
                } else if (line && currentMainItem) {
                    currentMainItem += ' ' + line;
                }
            }
            
            if (inSubList && subItems.length > 0) {
                currentMainItem += '<ul>' + subItems.map(item => `<li>${item}</li>`).join('') + '</ul>';
            }
            
            if (currentMainItem) {
                result += `<li>${currentMainItem}</li>`;
            }
            
            if (inMainList) {
                result += '</ul>';
            }
            
            return result;
        }

        function showTyping() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot';
            typingDiv.id = 'typing-indicator';
            
            const typingContent = document.createElement('div');
            typingContent.className = 'typing-indicator';
            typingContent.style.display = 'block';
            typingContent.innerHTML = `
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            `;
            
            typingDiv.appendChild(typingContent);
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTyping() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            
            if (chatInterface.classList.contains('active')) {
                chatMessages.appendChild(errorDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } else {
                document.querySelector('.file-upload-section').appendChild(errorDiv);
            }
            
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            
            document.querySelector('.file-upload-section').appendChild(successDiv);
            
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.remove();
                }
            }, 3000);
        }

        async function sendMessage(prompt = null, showUserMessage = true) {
            const userText = prompt || messageInput.value.trim();
            if (!userText) return;

            if (showUserMessage) {
                addMessage(userText, true);
            }
            if (!prompt) {
                messageInput.value = '';
            }

            messageInput.disabled = true;
            sendButton.disabled = true;
            showTyping();

            try {
                const config = analysisConfig[activeAnalysis];
                let messages = [];

                // Build or extend conversation
                if (conversation.length === 0) {
                    if (currentCsvData) {
                        try {
                            const colCount = Array.isArray(currentCsvData) && currentCsvData[0] ? Object.keys(currentCsvData[0]).length : 0;
                            console.log(`[SEND] Starting session with CSV (rows=${Array.isArray(currentCsvData) ? currentCsvData.length : 0}, cols=${colCount}) for analysis='${activeAnalysis}'`);
                        } catch(_) {}
                        const minimalInstruction = (promptEditor.value && promptEditor.value.trim()) || (config.prompt || '');
                        const minimalData = createMinimalDataBlock(currentCsvData);
                        initialFullPrompt = `${minimalInstruction}\n\n${minimalData}`;
                        messages.push({ role: 'user', content: initialFullPrompt });
                        // If first turn is a real question (not Analyze), include it explicitly
                        if (!prompt || (prompt && prompt.toLowerCase() !== 'analyze')) {
                            messages.push({ role: 'user', content: userText });
                        }
                    } else {
                        console.warn(`[SEND] No CSV dataset available to attach for analysis='${activeAnalysis}'. Starting without data.`);
                        const minimalInstruction = (promptEditor.value && promptEditor.value.trim()) || (config.prompt || '');
                        messages.push({ role: 'user', content: minimalInstruction });
                        if (!prompt || (prompt && prompt.toLowerCase() !== 'analyze')) {
                            messages.push({ role: 'user', content: userText });
                        }
                    }
                } else {
                    messages = conversation.slice();
                    messages.push({ role: 'user', content: userText });
                }

                const formData = new FormData();
                formData.append('messages', JSON.stringify(messages));
                const effectiveAnalysisType = includeDocs ? `${activeAnalysis}-docs` : activeAnalysis;
                formData.append('analysisType', effectiveAnalysisType);
                formData.append('useDocuments', includeDocs);
                formData.append('model', selectedModel);

                if (currentPdfData) {
                    console.log('[SEND] Attaching document to request:', currentPdfData.name, currentPdfData.type, currentPdfData.size);
                    formData.append('pdfFile', currentPdfData);
                    formData.append('hasPdf', 'true');
                }

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 240000);
                const response = await fetch('/Chatbot/api/chat', { method: 'POST', body: formData, signal: controller.signal });
                clearTimeout(timeoutId);

                const data = await response.json();
                hideTyping();

                if (response.ok) {
                    // Update conversation state
                    conversation = messages.slice();
                    conversation.push({ role: 'assistant', content: data.response });
                    addMessage(data.response);
                } else {
                    showError(data.error || 'Something went wrong');
                }
            } catch (error) {
                hideTyping();
                if (error.name === 'AbortError') {
                    showError('Request timed out. The analysis is taking longer than expected. Please try again or use a smaller dataset.');
                } else {
                    showError('Network error. Please check your connection.');
                }
                console.error('Error:', error);
            } finally {
                messageInput.disabled = false;
                sendButton.disabled = false;
                if (chatInterface.classList.contains('active')) {
                    messageInput.focus();
                }
            }
        }

        sendButton.addEventListener('click', () => sendMessage());
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>
